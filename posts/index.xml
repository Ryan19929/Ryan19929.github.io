<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on Ryan19929&#39;s blog</title>
    <link>http://localhost:1313/posts/</link>
    <description>Recent content in Posts on Ryan19929&#39;s blog</description>
    <generator>Hugo</generator>
    <language>en-us</language>
    <copyright>© Athul</copyright>
    <lastBuildDate>Sun, 26 Jan 2025 14:49:42 +0800</lastBuildDate>
    <atom:link href="http://localhost:1313/posts/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>IK不同平台上性能差异问题复盘</title>
      <link>http://localhost:1313/posts/ik-performance-review/</link>
      <pubDate>Sun, 26 Jan 2025 14:49:42 +0800</pubDate>
      <guid>http://localhost:1313/posts/ik-performance-review/</guid>
      <description>&lt;h1 id=&#34;起因&#34;&gt;起因&lt;/h1&gt;&#xA;&lt;p&gt;在优化IK分词器的过程中，发现C++版本在性能上落后于Java版本。在解决了内存频繁申请和回收的问题后，C++版本在Mac平台上的性能已经接近jieba_cpp版本。然而，在Linux服务器上，C++版本的性能仅与ik_java持平，与jieba_cpp的性能差距依然显著。&lt;/p&gt;&#xA;&lt;h1 id=&#34;排查的过程&#34;&gt;排查的过程&lt;/h1&gt;&#xA;&lt;h2 id=&#34;perf工具分析&#34;&gt;Perf工具分析&lt;/h2&gt;&#xA;&lt;p&gt;通过Perf工具生成的报告显示，basic_string::compare函数占用了较多的CPU资源(10%，callgrind函数调用占20%+)。然而，由于Perf未能明确显示该函数的调用者，初步推测可能是正常调用，因此暂时搁置了该区域的进一步调查，转而关注其他热点函数。&lt;/p&gt;&#xA;&lt;h2 id=&#34;instruments工具分析&#34;&gt;Instruments工具分析&lt;/h2&gt;&#xA;&lt;p&gt;在Mac平台上，使用Instruments工具收集CPU耗时数据。通过逐步优化代码质量较差的区域，每次优化带来2-5%的性能提升。最终，在引入内存池后，性能得到了显著提升，代码执行时间从约220秒优化至180秒左右。此后进一步优化的空间变得有限。&lt;/p&gt;&#xA;&lt;h2 id=&#34;callgrind-工具分析&#34;&gt;Callgrind 工具分析&lt;/h2&gt;&#xA;&lt;p&gt;使用Callgrind工具分析函数调用情况。由于使用800MB大小的数据集时，Callgrind收集数据的时间过长（数小时），一度误以为工具卡死。最终的报告清晰地揭示了lockBuffer和unlockBuffer函数调用了字符串的compare函数，并且占用27%。&#xA;然而，Perf报告中unlockBuffer和lockBuffer的CPU占用率仅为3%，且在火焰图中的位置并不显眼，80%的CPU时间消耗在分词器的analysis部分，因此这些函数的影响被忽视。&lt;/p&gt;&#xA;&lt;h1 id=&#34;代码分析&#34;&gt;代码分析&lt;/h1&gt;&#xA;&lt;p&gt;以CJK_SEGMENTER为例，相关代码如下：&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// CJK_Segmenter&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;const&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;string CJKSegmenter&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;SEGMENTER_NAME &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CJK_SEGMENTER&amp;#34;&lt;/span&gt;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;context.lockBuffer(SEGMENTER_NAME);&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;// AnalyzeContext&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; AnalyzeContext&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;lockBuffer(&lt;span style=&#34;color:#66d9ef&#34;&gt;const&lt;/span&gt; std&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;string&lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; segmenterName) {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (segmenterName &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CJK_SEGMENTER&amp;#34;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        buffer_locker_ &lt;span style=&#34;color:#f92672&#34;&gt;|=&lt;/span&gt; CJK_SEGMENTER_FLAG;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;if&lt;/span&gt; (segmenterName &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CN_QUANTIFIER&amp;#34;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        buffer_locker_ &lt;span style=&#34;color:#f92672&#34;&gt;|=&lt;/span&gt; CN_QUANTIFIER_FLAG;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;if&lt;/span&gt; (segmenterName &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;LETTER_SEGMENTER&amp;#34;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        buffer_locker_ &lt;span style=&#34;color:#f92672&#34;&gt;|=&lt;/span&gt; LETTER_SEGMENTER_FLAG;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;void&lt;/span&gt; AnalyzeContext&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;unlockBuffer(SegmenterType type) {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;switch&lt;/span&gt; (type) {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;case&lt;/span&gt; SegmenterType&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;CJK_SEGMENTER:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        buffer_locker_ &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;CJK_SEGMENTER_FLAG;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;break&lt;/span&gt;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;case&lt;/span&gt; SegmenterType&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;CN_QUANTIFIER:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        buffer_locker_ &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;CN_QUANTIFIER_FLAG;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;break&lt;/span&gt;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;case&lt;/span&gt; SegmenterType&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;LETTER_SEGMENTER:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        buffer_locker_ &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;=&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;LETTER_SEGMENTER_FLAG;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;break&lt;/span&gt;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;unlocklockbuffer函数耗时原因&#34;&gt;unlock/lockBuffer函数耗时原因&lt;/h2&gt;&#xA;&lt;p&gt;IK分词器处理文本的粒度是单个字符，每个字符的处理都需要调用所有子分词器。因此，lockBuffer函数的调用次数为：length(文本长度) * 3(子分词器数量) * (1-3)，调用频率极高。&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
